#!/usr/bin/env node

var program = require('commander');
var utils = require('../lib/utils');

/**
 * @TODO: remove coloured-log (it can't print errors...)
 */
var Log = require('coloured-log');
var log = new Log(Log.INFO);
var knexMigrator;

utils.getKnexMigrator({path: process.cwd()})
    .then(function (KnexMigrator) {
        program
            .option('--v <item>')
            .option('--only <item>')
            .option('--force')
            .parse(process.argv);

        try {
            knexMigrator = new KnexMigrator();
        } catch (err) {
            log.error(err.message);
            process.exit();
        }

        return knexMigrator.migrate({
            version: program.v,
            only: program.only,
            force: program.force
        }).then(function () {
            log.info('Finished database migration!');
        });
    })
    .catch(function (err) {
        log.error(err.message);
        err.context && log.notice(err.context);
        err.help && log.notice(err.help);
    });
